name: On Failure

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  report:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Post failure summary as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const pr = (run.pull_requests && run.pull_requests[0]) ? run.pull_requests[0] : null;
            if (!pr) {
              core.info('No associated PR found; skipping comment.');
              return;
            }

            const { data: jobs } = await github.request('GET /repos/{owner}/{repo}/actions/runs/{run_id}/jobs', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id
            });

            const failedJobs = jobs.jobs
              .filter(j => j.conclusion !== 'success')
              .map(j => `- ${j.name}: ${j.conclusion}`)
              .join('\n');

            const logsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${run.id}`;

            const body = [
              `‚ùå CI checks failed for this PR.`,
              ``,
              `Failed jobs:`,
              failedJobs ? failedJobs : '- (see logs)',
              ``,
              `[View full logs here](${logsUrl}).`,
              ``,
              `Quick fixes (frontend):`,
              `- Format: \`npm run format\``,
              `- Lint auto-fix: \`npm run lint:fix\``,
              `- Types: \`npm run type-check\``,
              ``,
              `Backend notes: minimal tests run without dlib/face_recognition; see backend/INSTALLATION.md for full setup.`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body
            });

